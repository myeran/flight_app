# flight_app
שרות להזמנת טיסות לתושבי אילת.
אני אסביר לך מה הקוד הזה עושה בצורה ברורה ומסודרת:

### תיאור כללי
הקוד הזה הוא אפליקציית Flask שמבצעת גרידת נתונים (Web Scraping) של טיסות פנים בארץ מאתר Israir, מאחסנת אותם בקאש, מאפשרת למשתמשים לבחור טיסות לעקוב אחריהן, ושולחת התראות SMS במקרה של שינויים (אם מופעל). הוא משתמש ב-Selenium לטעינת דפי האינטרנט וב-Twilio לשליחת הודעות.

---

### חלקים עיקריים בקוד

#### 1. **ייבוא ספריות**
- **Flask**: מסגרת לבניית אפליקציות ווב.
- **Selenium**: כלי לגרידת דפי אינטרנט דינמיים.
- **webdriver_manager**: מנהל אוטומטי להורדה והתקנה של ChromeDriver.
- **Twilio**: לשליחת הודעות SMS.
- **וספריות נוספות** כמו `json`, `os`, `logging`, ו-`threading` לניהול קבצים, לוגים ותהליכים מקבילים.

#### 2. **הגדרות ראשוניות**
- **לוגים**: משתמש ב-`logging` לרישום פעולות ושגיאות.
- **קאש**: שומר נתוני טיסות בקובץ JSON (`flight_cache.json`) למשך 24 שעות.
- **Twilio**: הגדרות לשליחת SMS (צריך למלא את ה-`xxx` עם פרטים אמיתיים כדי שיעבוד).
- **משתנים גלובליים**: 
  - `SELECTED_FLIGHTS`: מילון של טיסות שנבחרו למעקב.
  - `LAST_RUN_TIME`: זמן הריצה האחרונה של חיפוש.

#### 3. **פונקציות עיקריות**

##### `setup_driver(headless=False)`
- מגדיר את דפדפן Chrome לשימוש עם Selenium.
- משתמש ב-`ChromeDriverManager` להורדה אוטומטית של ChromeDriver.
- תומך במצב "headless" (ללא ממשק גרפי) אם נדרש.
- מוסיף אפשרויות כמו "no-sandbox" ו-user-agent מזויף כדי לחקות משתמש אמיתי.

##### `scrape_flights(args)`
- מקבלת תאריך, מקור, יעד וכיוון (הלוך/חזור) כקלט.
- בודקת קאש: אם יש נתונים עדכניים (פחות מ-24 שעות), מחזירה אותם.
- אם אין קאש או שהוא ישן, מבצעת גרידה מאתר Israir:
  - בונה URL דינמי לפי הפרמטרים.
  - משתמשת ב-Selenium כדי לטעון את הדף ולחכות לטעינת כרטיסיות הטיסות.
  - מחלצת פרטים כמו זמן המראה, נחיתה, מחיר, מקומות פנויים, קוד טיסה, חברת תעופה וקישור להזמנה.
- אם אין טיסות, מחזירה רשומה ריקה עם "אין טיסות".
- שומרת את התוצאות בקאש ומחזירה אותן.

##### `monitor_selected_flights()`
- רץ בשרשור (thread) נפרד ומתעדכן כל דקה.
- בודק את הטיסות שנבחרו ב-`SELECTED_FLIGHTS`.
- משווה את מספר המקומות הנוכחי לזה הקודם:
  - אם יש שינוי, מסמן `changed=True` ושולח SMS (אם `ENABLE_SMS=True`).
- מעדכן את הנתונים בזמן אמת.

##### `send_sms(message)`
- שולחת הודעת SMS דרך Twilio עם ההודעה המבוקשת.

#### 4. **נתיבי Flask (Routes)**

##### `/` (GET/POST)
- **GET**: מציג את ממשק ה-HTML עם תוצאות החיפוש האחרון (אם יש).
- **POST**: מקבל טווח תאריכים מהמשתמש, מבצע גרידה לכל יום בטווח עבור טיסות הלוך (ETM -> TLV) וחזור (TLV -> ETM), ומציג את התוצאות בטבלה.

##### `/book_flight` (POST)
- מקבל פרטי טיסה (תאריך, מקור, יעד, אינדקס).
- פותח דפדפן (לא headless) ומדמה לחיצה על כפתור "בחירה" והמשך להזמנה באתר Israir.
- משאיר את הדפדפן פתוח לדף ההזמנה.

##### `/reset_cache` (POST)
- מוחק את קובץ הקאש ומאפס את הנתונים השמורים.

##### `/add_selected_flight` (POST)
- מוסיף טיסה ל-`SELECTED_FLIGHTS` למעקב.

##### `/remove_selected_flight` (POST)
- מסיר טיסה מ-`SELECTED_FLIGHTS`.

##### `/get_selected_flights` (GET)
- מחזיר את רשימת הטיסות שנבחרו למעקב כ-JSON.

#### 5. **ריצת האפליקציה**
- מפעיל שרשור נפרד ל-`monitor_selected_flights`.
- מפעיל את שרת Flask על פורט 8000 עם כתובת IP ציבורית (`0.0.0.0`).

---

### מה הקוד עושה בפועל?
1. **חיפוש טיסות**: המשתמש מזין טווח תאריכים, והקוד מחפש טיסות מאילת לתל אביב וחזרה מאתר Israir.
2. **תצוגה**: מציג את התוצאות בדף HTML (דרך `render_template`).
3. **מעקב**: מאפשר למשתמש לבחור טיסות לעקוב אחריהן, ובודק שינויים כל דקה.
4. **הזמנה**: מאפשר ללחוץ על טיסה ולפתוח את דף ההזמנה בדפדפן.
5. **קאש**: ממטב את הביצועים על ידי שמירת נתונים בקובץ JSON למשך 24 שעות.
6. **התראות**: אם מופעל SMS, שולח הודעה על שינויים במקומות פנויים.

---

### דוגמה לפעולה
1. משתמש נכנס ל-`localhost:8000`, מזין תאריכים 01/04/2025 עד 03/04/2025.
2. הקוד גורף טיסות מאילת לת"א ומת"א לאילת לכל יום בטווח.
3. התוצאות מוצגות בטבלה עם פרטים כמו מחיר וזמנים.
4. המשתמש בוחר טיסה לניטור → הקוד בודק אותה כל דקה.
5. אם המקומות משתנים (למשל מ-5 ל-3), הוא מקבל SMS (אם Twilio מוגדר).

---

### הערות
- **Twilio**: צריך להחליף את `xxx` בפרטים אמיתיים כדי שישלח SMS.
- **HTML**: הקוד מניח שיש קובץ `flights.html` בתיקיית `templates`, שצריך ליצור בנפרד.
- **שגיאות**: יש טיפול נרחב בשגיאות עם לוגים מפורטים.

אם יש לך שאלות ספציפיות על חלק מסוים, תשאל וארחיב!
